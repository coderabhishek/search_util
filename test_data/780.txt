, we obtain |B| ≤ (n - 1)/2. Therefore, the number of nonwitnesses is at most (n - 1)/2,
so that the number of witnesses must be at least (n - 1)/2.
We now show how to find a proper subgroup B of
break the proof into two cases.
Case 1: There exists an

containing all of the nonwitnesses. We

such that

xn-1 ≢ 1 (mod n).
In other words, n is not a Carmichael number. Because, as we noted earlier, Carmichael
numbers are extremely rare, case 1 is the main case that arises "in practice" (e.g., when n has
been chosen randomly and is being tested for primality).
Let
. Clearly, B is nonempty, since 1 B. Since B is closed under
multiplication modulo n, we have that B is a subgroup of by Theorem 31.14. Note that
every nonwitness belongs to B, since a nonwitness a satisfies an-1 ≡ 1 (mod n). Since
we have that B is a proper subgroup of .
Case 2: For all

,

,

(31.39)
In other words, n is a Carmichael number. This case is extremely rare in practice. However,
the Miller-Rabin test (unlike a pseudo-primality test) can efficiently determine the
compositeness of Carmichael numbers, as we now show.
In this case, n cannot be a prime power. To see why, let us suppose to the contrary that n = pe,
where p is a prime and e > 1. We derive a contradiction as follows. Since n is assumed to be
odd, p must also be odd. Theorem 31.32 implies that is a cyclic group: it contains a
. By equation (31.39), we have
generator g such that
n-1
g ≡ 1 (mod n). Then the discrete logarithm theorem (Theorem 31.33, taking y = 0) implies
that n - 1 ≡ 0 (mod φ(n)), or
(p - 1)pe-1 | pe - 1.
This is a contradiction for e > 1, since (p - 1) pe-1 is divisible by the prime p but pe - 1 is not.
Thus, n is not a prime power.
Since the odd composite number n is not a prime power, we decompose it into a product n1n2,
where n1 and n2 are odd numbers greater than 1 that are relatively prime to each other. (There
may be several ways to do this, and it doesn't matter which one we choose. For example, if
, then we can choose
and
.)
Recall that we define t and u so that n - 1 = 2tu, where t ≥ 1 and u is odd, and that for an input
a, the procedure WITNESS computes the sequence

(all computations are performed modulo n).

