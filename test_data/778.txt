induction on i, the sequence x0, x1, ..., xt of values computed satisfies the equation

(mod

n) for i = 0, 1, ..., t, so that in particular xt ≢ a (mod n). Whenever a squaring step is
performed on line 4, however, the loop may terminate early if lines 5–6 detect that a
nontrivial square root of 1 has just been discovered. If so, the algorithm stops and returns
n-1

TRUE. Lines 7–8 return TRUE if the value computed for xt ≢ an-1 (mod n) is not equal to 1,
just as the PSEUDOPRIME procedure returns COMPOSITE in this case. Line 9 returns
FALSE if we haven't returned TRUE in lines 6 or 8.
We now argue that if WITNESS(a, n) returns TRUE, then a proof that n is composite can be
constructed using a.
If WITNESS returns TRUE from line 8, then it has discovered that xt = an-1 mod n ≠ 1. If n is
prime, however, we have by Fermat's theorem (Theorem 31.31) that an-1 ≢ 1 (mod n) for all
. Therefore, n cannot be prime, and the equation an-1 mod n ≠ 1 is a proof of this fact.
If WITNESS returns TRUE from line 6, then it has discovered that xi-1 is a nontrivial square
root of xi = 1, modulo n, since we have that xi-1 ≢ ±1 (mod n) yet
(mod n). Corollary
31.35 states that only if n is composite can there be a nontrivial square root of 1 modulo n, so
that a demonstration that xi-1 is a nontrivial square root of 1 modulo n is a proof that n is
composite.
This completes our proof of the correctness of WITNESS. If the invocation WITNESS(a, n)
outputs TRUE, then n is surely composite, and a proof that n is composite can be easily
determined from a and n.
At this point we briefly present an alternative description of the behavior of WITNESS as a
function of the sequence X = x0, x1, ..., xt , which you may find useful later on, when we
analyze the efficiency of the Miller-Rabin primality test. Note that if xi = 1 for some 0 ≤ i < t,
WITNESS might not compute the rest of the sequence. If it were to do so, however, each
value xi+1, xi+2, ..., xt would be 1, and we consider these positions in the sequence X as being
all 1's. We have four cases:
1. X = ..., d , where d ≠ 1: the sequence X does not end in 1. Return TRUE; a is a
witness to the compositeness of n (by Fermat's Theorem).
2. X = 1, 1, ..., 1 : the sequence X is all 1's. Return FALSE; a is not a witness to the
compositeness of n.
3. X = ..., -1, 1, ..., 1 : the sequence X ends in 1, and the last non-1 is equal to -1.
Return FALSE; a is not a witness to the compositeness of n.
4. X = ..., d, 1, ..., 1 , where d ≠ ±1: the sequence X ends in 1, but the last non-1 is not
-1. Return TRUE; a is a witness to the compositeness of n, since d is a nontrivial
square root of 1.
We now examine the Miller-Rabin primality test based on the use of WITNESS. Again, we
assume that n is an odd integer greater than 2.
MILLER-RABIN(n, s)
1 for j ← 1 to s
2
do a ← RANDOM(1, n - 1)
3
if WITNESS(a, n)

